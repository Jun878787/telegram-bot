import telebot
import re
from datetime import datetime, timedelta
from config import Config
from accounting import Accounting
from telebot.types import ReplyKeyboardMarkup, KeyboardButton
import json
import os
import logging

# åˆå§‹åŒ–æ©Ÿå™¨äººå’Œé…ç½®
bot = telebot.TeleBot('8076453380:AAHnaGkOtryyS-KecrnXcSq0agPclRTrUkQ')
config = Config()
accounting = Accounting()

# è¨­ç½®æ—¥èªŒè¨˜éŒ„
def setup_logging():
    """è¨­ç½®æ—¥èªŒè¨˜éŒ„"""
    # å‰µå»ºlogsç›®éŒ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if not os.path.exists('logs'):
        os.makedirs('logs')
    
    # è¨­ç½®æ—¥èªŒæ–‡ä»¶åï¼ˆä½¿ç”¨ç•¶å‰æ—¥æœŸï¼‰
    current_date = datetime.now().strftime('%Y-%m-%d')
    log_file = f'logs/bot_log_{current_date}.txt'
    
    # é…ç½®æ—¥èªŒè¨˜éŒ„å™¨
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(message)s',
        handlers=[
            logging.FileHandler(log_file, encoding='utf-8'),
            logging.StreamHandler()
        ]
    )
    return logging.getLogger('BotLogger')

# å‰µå»ºæ—¥èªŒè¨˜éŒ„å™¨
logger = setup_logging()

def log_message(message, action_type="ä¸€èˆ¬æ¶ˆæ¯"):
    """è¨˜éŒ„æ¶ˆæ¯åˆ°æ—¥èªŒ"""
    try:
        # ç²å–åŸºæœ¬ä¿¡æ¯
        user_id = message.from_user.id
        username = message.from_user.username or "æœªçŸ¥ç”¨æˆ¶å"
        chat_id = message.chat.id
        chat_title = message.chat.title if message.chat.title else "ç§èŠ"
        message_text = message.text or "ç„¡æ–‡å­—å…§å®¹"
        
        # æ ¼å¼åŒ–æ—¥èªŒæ¶ˆæ¯
        log_text = f"""
æ“ä½œé¡å‹: {action_type}
ç”¨æˆ¶ID: {user_id}
ç”¨æˆ¶å: {username}
ç¾¤çµ„ID: {chat_id}
ç¾¤çµ„å: {chat_title}
æ¶ˆæ¯å…§å®¹: {message_text}
------------------------"""
        
        # è¨˜éŒ„åˆ°æ—¥èªŒ
        logger.info(log_text)
    except Exception as e:
        logger.error(f"è¨˜éŒ„æ¶ˆæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

# å‰µå»ºéµç›¤æŒ‰éˆ•
def create_keyboard():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.row(
        KeyboardButton('ğŸ“œæ­·å²å¸³å–®'),
        KeyboardButton('ğŸ‘€ä½¿ç”¨èªªæ˜'),
        KeyboardButton('ğŸ“ç¾¤çµ„è¦ç« ')
    )
    keyboard.row(
        KeyboardButton('ğŸ› ï¸ä¿®å¾©æ©Ÿå™¨äºº'),
        KeyboardButton('ğŸ”§ç¾¤ç®¡åŠŸèƒ½')
    )
    return keyboard

def create_admin_settings_keyboard():
    """å‰µå»ºç¾¤ç®¡è¨­å®šéµç›¤"""
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.row(
        KeyboardButton('ğŸ‘‹æ­¡è¿è©è¨­å®š'),
        KeyboardButton('ğŸ‘‹ğŸ»å‘Šåˆ¥è©è¨­å®š')
    )
    keyboard.row(
        KeyboardButton('âš¡ï¸å¿«é€ŸæŒ‡ä»¤'),
        KeyboardButton('ğŸ“‹æŸ¥çœ‹ç®¡ç†å“¡')
    )
    keyboard.row(
        KeyboardButton('ğŸ”æŸ¥çœ‹æ“ä½œå“¡'),
        KeyboardButton('ğŸ”™è¿”å›ä¸»é¸å–®')
    )
    return keyboard

def create_farewell_settings_keyboard():
    """å‰µå»ºå‘Šåˆ¥è©è¨­å®šéµç›¤"""
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.row(
        KeyboardButton('âé—œé–‰å‘Šåˆ¥è¨Šæ¯'),
        KeyboardButton('âœ…é–‹å•Ÿå‘Šåˆ¥è¨Šæ¯')
    )
    keyboard.row(
        KeyboardButton('âœï¸è‡ªè¨‚å‘Šåˆ¥è¨Šæ¯'),
        KeyboardButton('ğŸš®åˆªé™¤èˆŠçš„å‘Šåˆ¥è¨Šæ¯')
    )
    keyboard.row(
        KeyboardButton('ğŸ”™è¿”å›ç¾¤ç®¡åŠŸèƒ½')
    )
    return keyboard

def get_admin_settings_message():
    """ç²å–ç¾¤ç®¡è¨­å®šèªªæ˜"""
    return """ğŸ”§ ç¾¤çµ„ç®¡ç†è¨­å®š

å¯ç”¨åŠŸèƒ½ï¼š
1ï¸âƒ£ ğŸ‘‹æ­¡è¿è©è¨­å®šï¼šè¨­å®šæ–°æˆå“¡åŠ å…¥æ™‚çš„æ­¡è¿è©
2ï¸âƒ£ âš¡ï¸å¿«é€ŸæŒ‡ä»¤ï¼šæŸ¥çœ‹æ‰€æœ‰ç®¡ç†å“¡æŒ‡ä»¤
3ï¸âƒ£ ğŸ“‹æŸ¥çœ‹ç®¡ç†å“¡ï¼šåˆ—å‡ºç›®å‰ç¾¤çµ„çš„æ‰€æœ‰ç®¡ç†å“¡
4ï¸âƒ£ ğŸ”æŸ¥çœ‹æ“ä½œå“¡ï¼šåˆ—å‡ºç›®å‰è¨­å®šçš„æ“ä½œå“¡

ç¾¤ç®¡æŒ‡ä»¤ï¼š
/ban - ç¦è¨€ç”¨æˆ¶
/unban - è§£é™¤ç¦è¨€
/kick - è¸¢å‡ºç”¨æˆ¶
/warn - è­¦å‘Šç”¨æˆ¶
/unwarn - ç§»é™¤è­¦å‘Š
/warns - æŸ¥çœ‹è­¦å‘Šæ¬¡æ•¸
/info - æŸ¥çœ‹ç”¨æˆ¶è³‡è¨Š
/del - åˆªé™¤è¨Šæ¯"""

@bot.message_handler(func=lambda message: message.text == 'ğŸ”§ç¾¤ç®¡åŠŸèƒ½')
def handle_admin_settings(message):
    """è™•ç†ç¾¤ç®¡åŠŸèƒ½è«‹æ±‚"""
    try:
        # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        # ç™¼é€ç¾¤ç®¡è¨­å®šèªªæ˜
        bot.reply_to(message, get_admin_settings_message(), reply_markup=create_admin_settings_keyboard())
    except Exception as e:
        bot.reply_to(message, f"âŒ é¡¯ç¤ºç¾¤ç®¡è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'ğŸ”™è¿”å›ä¸»é¸å–®')
def handle_return_main_menu(message):
    """è™•ç†è¿”å›ä¸»é¸å–®"""
    bot.reply_to(message, "å·²è¿”å›ä¸»é¸å–®", reply_markup=create_keyboard())

@bot.message_handler(func=lambda message: message.text == 'ğŸ‘‹æ­¡è¿è©è¨­å®š')
def handle_welcome_settings(message):
    """è™•ç†æ­¡è¿è©è¨­å®š"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        help_text = """ğŸ‘‹ æ­¡è¿è©è¨­å®šèªªæ˜

ç›®å‰æ­¡è¿è©ï¼š
ğŸ‘‹ æ­¡è¿ {SURNAME} Go to åŒ—é‡‘ Northâ„¢Sea á´8á´˜ğŸ‘‹

å¯ç”¨è®Šæ•¸ï¼š
{SURNAME} - æ–°æˆå“¡çš„ç”¨æˆ¶å
{FULLNAME} - æ–°æˆå“¡çš„å®Œæ•´åç¨±
{FIRSTNAME} - æ–°æˆå“¡çš„åå­—
{GROUPNAME} - ç¾¤çµ„åç¨±

è¨­å®šæ–¹å¼ï¼š
ç›´æ¥å›è¦† "è¨­å®šæ­¡è¿è©ï¼š" åŠ ä¸Šæ‚¨è¦çš„æ­¡è¿è©å…§å®¹
ä¾‹å¦‚ï¼šè¨­å®šæ­¡è¿è©ï¼šæ­¡è¿ {SURNAME} åŠ å…¥æˆ‘å€‘ï¼"""
        
        bot.reply_to(message, help_text)
    except Exception as e:
        bot.reply_to(message, f"âŒ é¡¯ç¤ºæ­¡è¿è©è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'ğŸ‘‹ğŸ»å‘Šåˆ¥è©è¨­å®š')
def handle_farewell_settings(message):
    """è™•ç†å‘Šåˆ¥è©è¨­å®š"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        # ç²å–ç•¶å‰ç‹€æ…‹
        enabled = config.get_farewell_enabled()
        status = "âœ… é–‹å•Ÿ" if enabled else "â é—œé–‰"
        
        help_text = f"""ğŸ‘‹ğŸ» å‘Šåˆ¥æ¨¡æ¿
å¾æ­¤é¸å–®ä¸­ï¼Œæ‚¨å¯ä»¥è¨­å®šç•¶æœ‰äººé›¢é–‹ç¾¤çµ„æ™‚å°‡åœ¨ç¾¤çµ„ä¸­ç™¼é€çš„å‘Šåˆ¥è¨Šæ¯ã€‚

ç‹€æ…‹: {status}

å¯ç”¨è®Šæ•¸ï¼š
{SURNAME} - é›¢é–‹æˆå“¡çš„ç”¨æˆ¶å
{FULLNAME} - é›¢é–‹æˆå“¡çš„å®Œæ•´åç¨±
{FIRSTNAME} - é›¢é–‹æˆå“¡çš„åå­—
{GROUPNAME} - ç¾¤çµ„åç¨±

ç•¶å‰å‘Šåˆ¥è©ï¼š
{config.get_farewell_message()}"""
        
        bot.reply_to(message, help_text, reply_markup=create_farewell_settings_keyboard())
    except Exception as e:
        bot.reply_to(message, f"âŒ é¡¯ç¤ºå‘Šåˆ¥è©è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'âé—œé–‰å‘Šåˆ¥è¨Šæ¯')
def handle_disable_farewell(message):
    """è™•ç†é—œé–‰å‘Šåˆ¥è¨Šæ¯"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        config.set_farewell_enabled(False)
        bot.reply_to(message, "âœ… å·²é—œé–‰å‘Šåˆ¥è¨Šæ¯")
    except Exception as e:
        bot.reply_to(message, f"âŒ é—œé–‰å‘Šåˆ¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'âœ…é–‹å•Ÿå‘Šåˆ¥è¨Šæ¯')
def handle_enable_farewell(message):
    """è™•ç†é–‹å•Ÿå‘Šåˆ¥è¨Šæ¯"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        config.set_farewell_enabled(True)
        bot.reply_to(message, "âœ… å·²é–‹å•Ÿå‘Šåˆ¥è¨Šæ¯")
    except Exception as e:
        bot.reply_to(message, f"âŒ é–‹å•Ÿå‘Šåˆ¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'âœï¸è‡ªè¨‚å‘Šåˆ¥è¨Šæ¯')
def handle_custom_farewell(message):
    """è™•ç†è‡ªè¨‚å‘Šåˆ¥è¨Šæ¯"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        help_text = """è«‹ç›´æ¥å›è¦† "è¨­å®šå‘Šåˆ¥è©ï¼š" åŠ ä¸Šæ‚¨è¦çš„å‘Šåˆ¥è©å…§å®¹
ä¾‹å¦‚ï¼šè¨­å®šå‘Šåˆ¥è©ï¼šğŸ‘‹ {SURNAME} å·²é›¢é–‹ç¾¤çµ„ï¼ŒæœŸå¾…å†ç›¸æœƒï¼

å¯ç”¨è®Šæ•¸ï¼š
{SURNAME} - é›¢é–‹æˆå“¡çš„ç”¨æˆ¶å
{FULLNAME} - é›¢é–‹æˆå“¡çš„å®Œæ•´åç¨±
{FIRSTNAME} - é›¢é–‹æˆå“¡çš„åå­—
{GROUPNAME} - ç¾¤çµ„åç¨±"""
        
        bot.reply_to(message, help_text)
    except Exception as e:
        bot.reply_to(message, f"âŒ é¡¯ç¤ºè‡ªè¨‚å‘Šåˆ¥è¨Šæ¯èªªæ˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text and message.text.startswith('è¨­å®šå‘Šåˆ¥è©ï¼š'))
def handle_set_farewell(message):
    """è™•ç†è¨­å®šå‘Šåˆ¥è©"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        farewell_text = message.text.replace('è¨­å®šå‘Šåˆ¥è©ï¼š', '').strip()
        if not farewell_text:
            bot.reply_to(message, "âŒ å‘Šåˆ¥è©ä¸èƒ½ç‚ºç©º")
            return
        
        config.set_farewell_message(farewell_text)
        bot.reply_to(message, f"âœ… å·²è¨­å®šæ–°çš„å‘Šåˆ¥è©ï¼š\n\n{farewell_text}")
    except Exception as e:
        bot.reply_to(message, f"âŒ è¨­å®šå‘Šåˆ¥è©æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'ğŸš®åˆªé™¤èˆŠçš„å‘Šåˆ¥è¨Šæ¯')
def handle_clear_old_farewell(message):
    """è™•ç†åˆªé™¤èˆŠçš„å‘Šåˆ¥è¨Šæ¯"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        # ç²å–ç•¶å‰æ¶ˆæ¯ID
        current_message_id = message.message_id
        
        # å¾ç•¶å‰æ¶ˆæ¯é–‹å§‹å¾€å‰æœå°‹ä¸¦åˆªé™¤å‘Šåˆ¥è¨Šæ¯
        for msg_id in range(current_message_id, 0, -1):
            try:
                msg = bot.get_chat_message(message.chat.id, msg_id)
                if msg and msg.text and "å·²é›¢é–‹ç¾¤çµ„" in msg.text:
                    bot.delete_message(message.chat.id, msg_id)
            except:
                continue
        
        bot.reply_to(message, "âœ… å·²æ¸…ç†èˆŠçš„å‘Šåˆ¥è¨Šæ¯")
    except Exception as e:
        bot.reply_to(message, f"âŒ æ¸…ç†èˆŠçš„å‘Šåˆ¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'ğŸ”™è¿”å›ç¾¤ç®¡åŠŸèƒ½')
def handle_return_admin_settings(message):
    """è™•ç†è¿”å›ç¾¤ç®¡åŠŸèƒ½"""
    handle_admin_settings(message)

@bot.message_handler(func=lambda message: message.text == 'âš¡ï¸å¿«é€ŸæŒ‡ä»¤')
def handle_quick_commands(message):
    """è™•ç†å¿«é€ŸæŒ‡ä»¤æŸ¥çœ‹"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        bot.reply_to(message, get_admin_commands_message())
    except Exception as e:
        bot.reply_to(message, f"âŒ é¡¯ç¤ºå¿«é€ŸæŒ‡ä»¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'ğŸ“‹æŸ¥çœ‹ç®¡ç†å“¡')
def handle_list_admins(message):
    """è™•ç†æŸ¥çœ‹ç®¡ç†å“¡åˆ—è¡¨"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        # ç²å–ç¾¤çµ„ç®¡ç†å“¡åˆ—è¡¨
        admins = bot.get_chat_administrators(message.chat.id)
        
        admin_list = "ğŸ“‹ ç¾¤çµ„ç®¡ç†å“¡åˆ—è¡¨ï¼š\n\n"
        for admin in admins:
            user = admin.user
            status = "ğŸ‘‘ ç¾¤ä¸»" if admin.status == "creator" else "ğŸ‘®â€â™‚ï¸ ç®¡ç†å“¡"
            admin_list += f"{status}ï¼š@{user.username or user.first_name}\n"
        
        bot.reply_to(message, admin_list)
    except Exception as e:
        bot.reply_to(message, f"âŒ ç²å–ç®¡ç†å“¡åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'ğŸ”æŸ¥çœ‹æ“ä½œå“¡')
def handle_list_operators(message):
    """è™•ç†æŸ¥çœ‹æ“ä½œå“¡åˆ—è¡¨"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        operators = config.get_operators()
        if not operators:
            bot.reply_to(message, "ç›®å‰æ²’æœ‰è¨­å®šä»»ä½•æ“ä½œå“¡")
            return
        
        operator_list = "ğŸ” æ“ä½œå“¡åˆ—è¡¨ï¼š\n\n"
        for operator_id in operators:
            try:
                user = bot.get_chat_member(message.chat.id, operator_id).user
                operator_list += f"@{user.username or user.first_name}\n"
            except:
                operator_list += f"ID: {operator_id}\n"
        
        bot.reply_to(message, operator_list)
    except Exception as e:
        bot.reply_to(message, f"âŒ ç²å–æ“ä½œå“¡åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text and message.text.startswith('è¨­å®šæ­¡è¿è©ï¼š'))
def handle_set_welcome(message):
    """è™•ç†è¨­å®šæ­¡è¿è©"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        welcome_text = message.text.replace('è¨­å®šæ­¡è¿è©ï¼š', '').strip()
        if not welcome_text:
            bot.reply_to(message, "âŒ æ­¡è¿è©ä¸èƒ½ç‚ºç©º")
            return
        
        config.set_welcome_message(welcome_text)
        bot.reply_to(message, f"âœ… å·²è¨­å®šæ–°çš„æ­¡è¿è©ï¼š\n\n{welcome_text}")
    except Exception as e:
        bot.reply_to(message, f"âŒ è¨­å®šæ­¡è¿è©æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

def format_time(time_str):
    """æ ¼å¼åŒ–æ™‚é–“ç‚º HHMM æ ¼å¼"""
    if not time_str:
        return ''
    
    # ç§»é™¤æ‰€æœ‰ç©ºæ ¼
    time_str = time_str.strip()
    
    # è™•ç† "4æœˆ16æ—¥ ä¸‹åˆï¼š16:30" é€™æ¨£çš„æ ¼å¼
    date_time_match = re.search(r'\d+æœˆ\d+æ—¥.*?(\d{1,2})[.:ï¼š](\d{2})', time_str)
    if date_time_match:
        hour = int(date_time_match.group(1))
        minute = int(date_time_match.group(2))
        return f"{hour:02d}:{minute:02d}"
    
    # è™•ç† "ä¸‹åˆ16:30" æˆ– "16:30" æ ¼å¼
    time_match = re.search(r'(?:[ä¸Šä¸‹åˆæ—©æ™š]åˆ?\s*)?(\d{1,2})[.:ï¼š](\d{2})', time_str)
    if time_match:
        hour = int(time_match.group(1))
        minute = int(time_match.group(2))
        return f"{hour:02d}:{minute:02d}"
    
    return time_str

def format_customer_name(name):
    """æ ¼å¼åŒ–å®¢æˆ¶åç¨±"""
    if not name:
        return ''
    name = name.strip()
    # å¦‚æœåªæœ‰ä¸€å€‹å­—
    if len(name) == 1:
        return f"{name}å…ˆç”Ÿ/å°å§"
    return name

def format_company_name(name):
    """æ ¼å¼åŒ–å…¬å¸åç¨±ï¼ˆå–å‰å››å€‹å­—ï¼‰"""
    if not name:
        return ''
    # ç§»é™¤ç©ºæ ¼ä¸¦å–å‰å››å€‹å­—
    name = name.strip()
    return name[:4]

def format_amount(amount_str):
    """æ ¼å¼åŒ–é‡‘é¡ç‚º XX.Xè¬ æ ¼å¼"""
    if not amount_str:
        return '0.0'
    
    # ç§»é™¤æ‰€æœ‰ç©ºæ ¼å’Œé€—è™Ÿ
    amount_str = amount_str.replace(' ', '').replace(',', '')
    
    # è™•ç†å¸¶æœ‰"è¬"å­—çš„æƒ…æ³
    if 'è¬' in amount_str:
        amount_str = amount_str.replace('è¬', '')
        try:
            return f"{float(amount_str):.1f}"
        except ValueError:
            return '0.0'
    
    # è™•ç†ä¸€èˆ¬æ•¸å­—
    try:
        amount = float(amount_str)
        # è½‰æ›ç‚ºè¬ç‚ºå–®ä½
        return f"{amount/10000:.1f}"
    except ValueError:
        return '0.0'

def extract_district(address):
    """æå–åœ°å€ä¸­çš„ç¸£å¸‚å€é„‰é®"""
    if not address:
        return ''
    
    # çµ±ä¸€å°‡å°æ”¹ç‚ºè‡º
    address = address.replace('å°', 'è‡º')
    
    # åŒ¹é…å®Œæ•´çš„ç¸£å¸‚å€é„‰é®æ ¼å¼
    match = re.search(r'([è‡ºå°][åŒ—ä¸­å—æ±è¥¿][å¸‚ç¸£])([^å¸‚ç¸£]{1,3}[å€é„‰é®å¸‚])', address)
    if match:
        city = match.group(1).replace('è‡º', 'å°')
        district = match.group(2)
        return f"{city}{district}"
    
    return address

def find_company_name(text):
    """å¾æ–‡æœ¬ä¸­æœå°‹å…¬å¸åç¨±"""
    if not text:
        return ''
    
    # æœå°‹åŒ…å«"æœ‰é™å…¬å¸"æˆ–"è‚¡ä»½æœ‰é™å…¬å¸"çš„å®Œæ•´åç¨±
    company_patterns = [
        r'([^\n\r]+?è‚¡ä»½æœ‰é™å…¬å¸)',  # åŒ¹é…è‚¡ä»½æœ‰é™å…¬å¸
        r'([^\n\r]+?æœ‰é™å…¬å¸)',      # åŒ¹é…ä¸€èˆ¬æœ‰é™å…¬å¸
    ]
    
    for pattern in company_patterns:
        match = re.search(pattern, text)
        if match:
            company_name = match.group(1).strip()
            # å¦‚æœå…¬å¸åç¨±è¶…é4å€‹å­—ï¼Œåªå–å‰4å€‹å­—
            if len(company_name) > 4:
                return company_name[:4]
            return company_name
    
    return ''

def extract_information(text, field_names):
    """å¾æ–‡æœ¬ä¸­æå–æŒ‡å®šå­—æ®µçš„ä¿¡æ¯"""
    if not text:
        return ''
    
    # æŒ‰è¡Œæœç´¢
    lines = text.split('\n')
    for line in lines:
        for field_name in field_names:
            # è™•ç†å¸¶æ•¸å­—ç·¨è™Ÿçš„æ ¼å¼ï¼ˆå¦‚ï¼š1.å®¢æˆ¶åç¨±ã€2.é›»è©±ï¼‰
            field_pattern = f'(?:(?:\\d+\\.)?{field_name}|{field_name})[:ï¼š]\\s*'
            match = re.search(field_pattern, line)
            if match:
                value = line[match.end():].strip()
                return value
    
    # å¦‚æœæ˜¯åœ¨æ‰¾å…¬å¸åç¨±ä¸”æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦è‡ªå‹•æœå°‹
    if 'å…¬å¸åç¨±' in field_names:
        return find_company_name(text)
    
    return ''

@bot.message_handler(func=lambda message: message.text == 'åˆ—è¡¨' and message.reply_to_message)
def handle_list_command(message):
    """è™•ç†åˆ—è¡¨å‘½ä»¤"""
    original_text = message.reply_to_message.text
    if not original_text:
        return

    # æå–å„é …ä¿¡æ¯
    company_name = format_company_name(extract_information(original_text, ['å…¬å¸åç¨±']))
    customer_name = format_customer_name(extract_information(original_text, ['å®¢æˆ¶åç¨±', 'å®¢æˆ¶å§“å', 'å®¢æˆ¶', 'å§“å', 'å§“åï¼š']))
    
    # è™•ç†é‡‘é¡ï¼Œæ”¯æ´"Xè¬"æ ¼å¼
    amount_text = extract_information(original_text, ['æ”¶æ¬¾é‡‘é¡', 'å„²å€¼é‡‘é¡', 'é¡åº¦', 'é‡‘é¡', 'å­˜å…¥æ“ä½œé‡‘é¡'])
    amount = format_amount(amount_text)
    
    # è™•ç†æ™‚é–“
    time = format_time(extract_information(original_text, ['æ™‚é–“', 'æ”¶æ¬¾æ™‚é–“', 'é ç´„æ™‚é–“', 'æ—¥æœŸæ™‚é–“']))
    
    # è™•ç†åœ°å€
    address = extract_district(extract_information(original_text, ['å…¬å¸åœ°å€', 'é ç´„åœ°å€', 'æ”¶æ¬¾åœ°å€', 'æ”¶æ¬¾åœ°é»', 'äº¤æ˜“åœ°é»', 'åœ°é»']))

    # æ ¼å¼åŒ–æ¶ˆæ¯
    formatted_message = f'{time}ã€{company_name}-{amount}è¬ã€‘{customer_name}ã€{address}ã€‘'

    # ç™¼é€æ ¼å¼åŒ–æ¶ˆæ¯
    bot.reply_to(message, formatted_message)

def format_summary(amount, rate):
    """æ ¼å¼åŒ–é‡‘é¡å’ŒUSDT"""
    try:
        amount = float(amount)
        rate = float(rate)
        usdt = amount / rate if rate > 0 else 0
        return f"{amount:,.0f} | {usdt:.2f}(USDT)"
    except (ValueError, TypeError):
        return "0 | 0.00(USDT)"

def get_transaction_message():
    """ç”Ÿæˆäº¤æ˜“æ‘˜è¦æ¶ˆæ¯"""
    try:
        summary = config.get_transaction_summary()
        rates = config.get_rates()
        
        # å…¥æ¬¾éƒ¨åˆ† - åªé¡¯ç¤ºæœ€è¿‘ 2 ç­†
        message = f"ğŸŸ¢å…¥æ¬¾ï¼ˆ{summary['deposit_count']}ç­†ï¼‰ï¼š\n"
        if summary['deposits']:
            recent_deposits = summary['deposits'][-2:]  # åªå–æœ€å¾Œ 2 ç­†
            for deposit in recent_deposits:
                time = format_time(deposit['time'])
                message += f"{time} {deposit['amount']:,.0f}\n"
        else:
            message += "æš«ç„¡å…¥æ¬¾\n"
        
        # å‡ºæ¬¾éƒ¨åˆ†
        message += f"\nğŸ”´å‡ºæ¬¾ï¼ˆ{summary['withdrawal_count']}ç­†ï¼‰ï¼š\n"
        if summary['withdrawals']:
            for withdrawal in summary['withdrawals']:
                time = format_time(withdrawal['time'])
                amount = abs(withdrawal['amount'])  # ä½¿ç”¨çµ•å°å€¼
                message += f"{time} -{amount:,.0f}\n"
        else:
            message += "æš«ç„¡å‡ºæ¬¾\n"
        
        # åŒ¯ç‡ä¿¡æ¯
        message += f"\nå…¥æ¬¾åŒ¯ç‡ï¼š{rates['deposit']}"
        message += f"\nå‡ºæ¬¾åŒ¯ç‡ï¼š{rates['withdrawal']}"
        message += f"\nç¸½å…¥æ¬¾é‡‘é¡ï¼š{summary['total_deposit']:,.0f}"
        
        # è¨ˆç®—ä¸‹ç™¼é‡‘é¡
        total_deposit = float(summary['total_deposit'])
        processed_amount = float(summary['processed_amount'])
        unprocessed_amount = total_deposit - processed_amount
        
        # ä¸‹ç™¼ä¿¡æ¯
        message += f"\n\næ‡‰ä¸‹ç™¼ï¼š{format_summary(total_deposit, rates['deposit'])}"
        
        # å·²ä¸‹ç™¼é‡‘é¡é¡¯ç¤ºç‚ºæ­£æ•¸ï¼Œä¸¦ä½¿ç”¨å‡ºæ¬¾åŒ¯ç‡è¨ˆç®—USDT
        withdrawal_rate = float(rates['withdrawal'])
        if processed_amount != 0:
            processed_amount_abs = abs(processed_amount)
            usdt_amount = processed_amount_abs / withdrawal_rate if withdrawal_rate > 0 else 0
            message += f"\nå·²ä¸‹ç™¼ï¼š{processed_amount_abs:,.0f} | {usdt_amount:.2f}(USDT)"
        else:
            message += f"\nå·²ä¸‹ç™¼ï¼š0 | 0.00(USDT)"
            
        # æœªä¸‹ç™¼é‡‘é¡
        message += f"\næœªä¸‹ç™¼ï¼š{format_summary(unprocessed_amount, rates['withdrawal'])}"
        
        return message
    except Exception as e:
        print(f"ç”Ÿæˆäº¤æ˜“æ‘˜è¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")
        return "ç”Ÿæˆäº¤æ˜“æ‘˜è¦æ™‚ç™¼ç”ŸéŒ¯èª¤"

def get_history_message():
    """ç”Ÿæˆæ­·å²å¸³å–®æ¶ˆæ¯"""
    try:
        summary = config.get_transaction_summary()
        
        message = "ğŸ“œ æ­·å²å¸³å–®ï¼š\n\n"
        
        # é¡¯ç¤ºæ‰€æœ‰å…¥æ¬¾è¨˜éŒ„
        message += "ğŸŸ¢å…¥æ¬¾è¨˜éŒ„ï¼š\n"
        if summary['deposits']:
            for deposit in summary['deposits']:
                time = format_time(deposit['time'])
                message += f"{time} +{deposit['amount']:,.0f}\n"
        else:
            message += "æš«ç„¡å…¥æ¬¾è¨˜éŒ„\n"
        
        # é¡¯ç¤ºæ‰€æœ‰å‡ºæ¬¾è¨˜éŒ„
        message += "\nğŸ”´å‡ºæ¬¾è¨˜éŒ„ï¼š\n"
        if summary['withdrawals']:
            for withdrawal in summary['withdrawals']:
                time = format_time(withdrawal['time'])
                message += f"{time} -{withdrawal['amount']:,.0f}\n"
        else:
            message += "æš«ç„¡å‡ºæ¬¾è¨˜éŒ„\n"
        
        return message
    except Exception as e:
        print(f"ç”Ÿæˆæ­·å²å¸³å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")
        return "ç”Ÿæˆæ­·å²å¸³å–®æ™‚ç™¼ç”ŸéŒ¯èª¤"

def get_admin_help_message():
    """ç”Ÿæˆç®¡ç†å“¡ä½¿ç”¨èªªæ˜"""
    return """åŒ—é‡‘ Northâ„¢Sea á´8á´˜ å°ˆå±¬æ©Ÿå™¨äºº
-----------------------------------------------
åƒ…é™ç¾¤çµ„ä¸»æˆ–ç¾¤çµ„ç®¡ç†å“¡ä½¿ç”¨

ğŸ”´è¨­å®šæ“ä½œå“¡ @xxxxx @ccccc
ğŸ”´æŸ¥çœ‹æ“ä½œå“¡
ğŸ”´åˆªé™¤æ“ä½œå“¡ @xxxxx @ccccc
ğŸ”´åˆªé™¤å¸³å–®
ğŸ”´åˆªé™¤æ­·å²å¸³å–® æ…ç”¨
-----------------------------------------------
ç¾¤çµ„ä¸»æˆ–è€…ç¾¤çµ„ç®¡ç†å“¡æˆ–æ“ä½œäºº

ğŸ”´è¨­å®šå…¥æ¬¾åŒ¯ç‡33.25
ğŸ”´è¨­å®šå‡ºæ¬¾åŒ¯ç‡33.25

ğŸŸ¢ å…¥æ¬¾æ“ä½œ
ğŸ”¹ +1000

ğŸŸ¢ å‡ºæ¬¾æ™®é€šé‡‘é¡
ğŸ”¹ -1000

ğŸ”´ä¿®æ­£å‘½ä»¤ å…¥æ¬¾-100 å‡ºæ¬¾-100
ğŸ”´å…¥æ¬¾æ’¤éŠ· æ’¤éŠ·æœ€è¿‘ä¸€ç­†å…¥æ¬¾å¸³å–®
ğŸ”´å‡ºæ¬¾æ’¤éŠ· æ’¤éŠ·æœ€è¿‘ä¸€ç­†å‡ºæ¬¾å¸³å–®
ğŸ”´+0  é¡¯ç¤ºå¸³å–®

ğŸŸ¢ è¨ˆç®—å™¨
ğŸ”¹ (500+600)*8+(600-9)/5
ğŸ”¹ 500+600+800/85

ğŸ”´è¨­å®šç¾¤ç™¼å»£æ’­ ç¾¤ç™¼å»£æ’­è¨Šæ¯
ğŸ”´å–æ¶ˆç¾¤ç™¼å»£æ’­ å–æ¶ˆç¾¤ç™¼å»£æ’­è¨Šæ¯

ğŸ”ºåˆªé™¤æ‰€æœ‰èŠå¤©å®¤è¨Šæ¯
ğŸ”ºåˆªé™¤æ‰€æœ‰éç½®é ‚è¨Šæ¯"""

def get_operator_help_message():
    """ç”Ÿæˆæ“ä½œäººä½¿ç”¨èªªæ˜"""
    return """åŒ—é‡‘ Northâ„¢Sea á´8á´˜ å°ˆå±¬æ©Ÿå™¨äºº
-----------------------------------------------

ğŸŸ¢ è¨ˆç®—å™¨
ğŸ”¹ (500+600)*8+(600-9)/5
ğŸ”¹ 500+600+800/85

ğŸ”´ åˆ—è¡¨
åœ¨è¦åˆ—è¡¨çš„æ–‡å­—è¨Šæ¯å›è¦† "åˆ—è¡¨" å°±æœƒè‡ªå‹•å¹«æ‚¨æŠŠæ ¼å¼åˆ—è¡¨å®Œç•¢å›‰ï¼"""

def create_help_keyboard():
    """å‰µå»ºä½¿ç”¨èªªæ˜çš„éµç›¤æŒ‰éˆ•"""
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.row(
        KeyboardButton('ğŸ‘®â€â™‚ï¸ç®¡ç†å“¡æŒ‰éˆ•'),
        KeyboardButton('âœï¸æ“ä½œäººæŒ‰éˆ•')
    )
    return keyboard

@bot.message_handler(func=lambda message: message.text == 'ğŸ‘€ä½¿ç”¨èªªæ˜')
def handle_help(message):
    """è™•ç†ä½¿ç”¨èªªæ˜è«‹æ±‚"""
    # é¡¯ç¤ºé¸æ“‡æŒ‰éˆ•
    bot.reply_to(message, "è«‹é¸æ“‡è¦æŸ¥çœ‹çš„èªªæ˜ï¼š", reply_markup=create_help_keyboard())

@bot.message_handler(func=lambda message: message.text == 'ğŸ‘®â€â™‚ï¸ç®¡ç†å“¡æŒ‰éˆ•')
def handle_admin_help(message):
    """è™•ç†ç®¡ç†å“¡èªªæ˜è«‹æ±‚"""
    bot.reply_to(message, get_admin_help_message(), reply_markup=create_keyboard())

@bot.message_handler(func=lambda message: message.text == 'âœï¸æ“ä½œäººæŒ‰éˆ•')
def handle_operator_help(message):
    """è™•ç†æ“ä½œäººèªªæ˜è«‹æ±‚"""
    bot.reply_to(message, get_operator_help_message(), reply_markup=create_keyboard())

@bot.message_handler(func=lambda message: message.text and message.text.startswith('[') and message.text.endswith(']'))
def handle_command(message):
    """è™•ç†å‘½ä»¤"""
    # ç§»é™¤æ–¹æ‹¬è™Ÿ
    command = message.text[1:-1]
    bot.reply_to(message, f"åŸ·è¡Œå‘½ä»¤ï¼š{command}")

def is_valid_calculation(text):
    """æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„è¨ˆç®—å…¬å¼"""
    # ç§»é™¤æ‰€æœ‰ç©ºæ ¼å’Œé€—è™Ÿ
    text = text.replace(' ', '').replace(',', '')
    
    # å¦‚æœä»¥+æˆ–-é–‹é ­ï¼Œç›´æ¥è¿”å›Falseï¼ˆé€™æ˜¯è¨˜å¸³åŠŸèƒ½ï¼‰
    if text.startswith('+') or text.startswith('-'):
        return False
    
    # æª¢æŸ¥æ˜¯å¦åŒ…å«é‹ç®—ç¬¦
    operators = '+-*/'
    operator_count = sum(text.count(op) for op in operators)
    if operator_count == 0:
        return False
    
    # æª¢æŸ¥æ‹¬è™Ÿæ˜¯å¦é…å°
    brackets_count = 0
    for c in text:
        if c == '(':
            brackets_count += 1
        elif c == ')':
            brackets_count -= 1
        if brackets_count < 0:  # å³æ‹¬è™Ÿå¤šæ–¼å·¦æ‹¬è™Ÿ
            return False
    
    # æª¢æŸ¥æ˜¯å¦åªåŒ…å«åˆæ³•å­—ç¬¦
    valid_chars = set('0123456789.+-*/() ')
    if not all(c in valid_chars for c in text):
        return False
    
    # æª¢æŸ¥æ•¸å­—çš„æ•¸é‡ï¼ˆè‡³å°‘éœ€è¦å…©å€‹æ•¸å­—ï¼‰
    numbers = [n for n in re.split(r'[+\-*/() ]+', text) if n]
    if len(numbers) < 2:
        return False
    
    # æª¢æŸ¥æ¯å€‹æ•¸å­—æ˜¯å¦æœ‰æ•ˆ
    try:
        for num in numbers:
            if num:
                float(num)
        return True
    except ValueError:
        return False

def evaluate_expression(expression):
    """è¨ˆç®—æ•¸å­¸è¡¨é”å¼"""
    try:
        # åŸºæœ¬å®‰å…¨æª¢æŸ¥ï¼šåªå…è¨±æ•¸å­—å’ŒåŸºæœ¬é‹ç®—ç¬¦
        if not all(c in '0123456789.+-*/() ' for c in expression):
            return None
            
        # è¨ˆç®—çµæœ
        result = eval(expression)
        
        # å¦‚æœçµæœæ˜¯æ•´æ•¸ï¼Œè¿”å›æ•´æ•¸æ ¼å¼
        if isinstance(result, (int, float)):
            if result.is_integer():
                return int(result)
            return round(result, 2)
        return None
    except:
        return None

@bot.message_handler(func=lambda message: message.text and is_valid_calculation(message.text))
def handle_calculator(message):
    """è™•ç†è¨ˆç®—å™¨åŠŸèƒ½"""
    try:
        # ç§»é™¤æ‰€æœ‰é€—è™Ÿå’Œç©ºæ ¼
        expression = message.text.replace(',', '').replace(' ', '')
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„è¨ˆç®—è¡¨é”å¼
        if not is_valid_calculation(expression):
            return  # å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„è¨ˆç®—è¡¨é”å¼ï¼Œç›´æ¥è¿”å›ï¼ˆå¯èƒ½æ˜¯è¨˜å¸³åŠŸèƒ½ï¼‰
        
        # è¨ˆç®—çµæœ
        result = evaluate_expression(expression)
        
        if result is not None:
            # æ ¼å¼åŒ–å¤§æ•¸å­—ï¼ˆåŠ ä¸Šåƒä½åˆ†éš”ç¬¦ï¼‰
            if isinstance(result, (int, float)):
                formatted_result = format(result, ',')
                bot.reply_to(message, f"{message.text} = {formatted_result}")
        else:
            return  # å¦‚æœè¨ˆç®—å¤±æ•—ï¼Œç›´æ¥è¿”å›ï¼ˆå¯èƒ½æ˜¯è¨˜å¸³åŠŸèƒ½ï¼‰
    except Exception as e:
        return  # å¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼Œç›´æ¥è¿”å›ï¼ˆå¯èƒ½æ˜¯è¨˜å¸³åŠŸèƒ½ï¼‰

@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "æ©Ÿå™¨äººå·²å•Ÿå‹•ï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨äº†ï¼", reply_markup=create_keyboard())

@bot.message_handler(func=lambda message: message.text == 'ğŸ“œæ­·å²å¸³å–®')
def handle_history(message):
    """è™•ç†æ­·å²å¸³å–®è«‹æ±‚"""
    bot.reply_to(message, get_history_message())

@bot.message_handler(func=lambda message: message.text and message.text.startswith('+'))
def handle_deposit(message):
    """è™•ç†å…¥æ¬¾æ“ä½œ"""
    try:
        # å¾æ¶ˆæ¯ä¸­æå–é‡‘é¡
        amount_str = message.text.strip()[1:]  # ç§»é™¤ '+' ç¬¦è™Ÿ
        # ç§»é™¤æ‰€æœ‰é€—è™Ÿ
        amount_str = amount_str.replace(',', '')
        amount = float(amount_str)
        
        # æ·»åŠ äº¤æ˜“è¨˜éŒ„
        config.add_transaction(amount, 'deposit')
        
        # å›è¦†å®Œæ•´äº¤æ˜“æ‘˜è¦
        bot.reply_to(message, get_transaction_message(), reply_markup=create_keyboard())
    except ValueError:
        bot.reply_to(message, "âŒ æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨ï¼š+é‡‘é¡")
    except Exception as e:
        bot.reply_to(message, f"âŒ è™•ç†å…¥æ¬¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text and message.text.startswith('-'))
def handle_withdrawal(message):
    """è™•ç†å‡ºæ¬¾æ“ä½œ"""
    try:
        # å¾æ¶ˆæ¯ä¸­æå–é‡‘é¡
        amount_str = message.text.strip()[1:]  # ç§»é™¤ '-' ç¬¦è™Ÿ
        # ç§»é™¤æ‰€æœ‰é€—è™Ÿ
        amount_str = amount_str.replace(',', '')
        amount = float(amount_str)
        
        # æ·»åŠ äº¤æ˜“è¨˜éŒ„
        config.add_transaction(amount, 'withdrawal')
        
        # å›è¦†å®Œæ•´äº¤æ˜“æ‘˜è¦
        bot.reply_to(message, get_transaction_message(), reply_markup=create_keyboard())
    except ValueError:
        bot.reply_to(message, "âŒ æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨ï¼š-é‡‘é¡")
    except Exception as e:
        bot.reply_to(message, f"âŒ è™•ç†å‡ºæ¬¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'åˆªé™¤å¸³å–®')
def handle_clear_today(message):
    """è™•ç†åˆªé™¤ä»Šæ—¥å¸³å–®çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "åˆªé™¤ä»Šæ—¥å¸³å–®")
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        config.clear_today_transactions()
        bot.reply_to(message, "âœ… å·²æ¸…ç©ºä»Šæ—¥å¸³å–®")
    except Exception as e:
        bot.reply_to(message, f"âŒ æ¸…ç©ºä»Šæ—¥å¸³å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'åˆªé™¤æ­·å²å¸³å–®')
def handle_clear_history(message):
    """è™•ç†åˆªé™¤æ­·å²å¸³å–®çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "åˆªé™¤æ­·å²å¸³å–®")
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        config.clear_all_transactions()
        bot.reply_to(message, "âœ… å·²æ¸…ç©ºæ‰€æœ‰æ­·å²å¸³å–®")
    except Exception as e:
        bot.reply_to(message, f"âŒ æ¸…ç©ºæ­·å²å¸³å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text and message.text.startswith('è¨­å®šå…¥æ¬¾åŒ¯ç‡'))
def handle_set_deposit_rate(message):
    """è™•ç†è¨­å®šå…¥æ¬¾åŒ¯ç‡çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "è¨­å®šå…¥æ¬¾åŒ¯ç‡")
        
        # æª¢æŸ¥æ¬Šé™
        if not (is_admin(message.from_user.id, message.chat.id) or is_operator(message.from_user.id)):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡æˆ–æ“ä½œå“¡ä½¿ç”¨")
            return
        
        # æå–åŒ¯ç‡æ•¸å€¼
        rate = float(message.text.replace('è¨­å®šå…¥æ¬¾åŒ¯ç‡', '').strip())
        config.set_deposit_rate(rate)
        bot.reply_to(message, f"âœ… å·²è¨­å®šå…¥æ¬¾åŒ¯ç‡ç‚ºï¼š{rate}")
    except ValueError:
        bot.reply_to(message, "âŒ åŒ¯ç‡æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨æ­£ç¢ºçš„æ•¸å­—æ ¼å¼")
    except Exception as e:
        bot.reply_to(message, f"âŒ è¨­å®šå…¥æ¬¾åŒ¯ç‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text and message.text.startswith('è¨­å®šå‡ºæ¬¾åŒ¯ç‡'))
def handle_set_withdrawal_rate(message):
    """è™•ç†è¨­å®šå‡ºæ¬¾åŒ¯ç‡çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "è¨­å®šå‡ºæ¬¾åŒ¯ç‡")
        
        # æª¢æŸ¥æ¬Šé™
        if not (is_admin(message.from_user.id, message.chat.id) or is_operator(message.from_user.id)):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡æˆ–æ“ä½œå“¡ä½¿ç”¨")
            return
        
        # æå–åŒ¯ç‡æ•¸å€¼
        rate = float(message.text.replace('è¨­å®šå‡ºæ¬¾åŒ¯ç‡', '').strip())
        config.set_withdrawal_rate(rate)
        bot.reply_to(message, f"âœ… å·²è¨­å®šå‡ºæ¬¾åŒ¯ç‡ç‚ºï¼š{rate}")
    except ValueError:
        bot.reply_to(message, "âŒ åŒ¯ç‡æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨æ­£ç¢ºçš„æ•¸å­—æ ¼å¼")
    except Exception as e:
        bot.reply_to(message, f"âŒ è¨­å®šå‡ºæ¬¾åŒ¯ç‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'å…¥æ¬¾æ’¤éŠ·')
def handle_cancel_last_deposit(message):
    """è™•ç†æ’¤éŠ·æœ€å¾Œä¸€ç­†å…¥æ¬¾çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "æ’¤éŠ·å…¥æ¬¾")
        
        # æª¢æŸ¥æ¬Šé™
        if not (is_admin(message.from_user.id, message.chat.id) or is_operator(message.from_user.id)):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡æˆ–æ“ä½œå“¡ä½¿ç”¨")
            return
        
        # ç²å–äº¤æ˜“æ‘˜è¦
        summary = config.get_transaction_summary()
        if not summary['deposits']:
            bot.reply_to(message, "âŒ æ²’æœ‰å¯æ’¤éŠ·çš„å…¥æ¬¾è¨˜éŒ„")
            return
        
        # ç²å–æœ€å¾Œä¸€ç­†å…¥æ¬¾é‡‘é¡ç”¨æ–¼é¡¯ç¤º
        last_amount = summary['deposits'][-1]['amount']
        
        # åŸ·è¡Œæ’¤éŠ·æ“ä½œ
        if config.cancel_last_deposit():
            bot.reply_to(message, f"âœ… å·²æ’¤éŠ·æœ€å¾Œä¸€ç­†å…¥æ¬¾ï¼š{last_amount:,.0f}")
            # æ›´æ–°äº¤æ˜“æ‘˜è¦
            bot.reply_to(message, get_transaction_message())
        else:
            bot.reply_to(message, "âŒ æ’¤éŠ·å…¥æ¬¾å¤±æ•—")
    except Exception as e:
        bot.reply_to(message, f"âŒ æ’¤éŠ·å…¥æ¬¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'å‡ºæ¬¾æ’¤éŠ·')
def handle_cancel_last_withdrawal(message):
    """è™•ç†æ’¤éŠ·æœ€å¾Œä¸€ç­†å‡ºæ¬¾çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "æ’¤éŠ·å‡ºæ¬¾")
        
        # æª¢æŸ¥æ¬Šé™
        if not (is_admin(message.from_user.id, message.chat.id) or is_operator(message.from_user.id)):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡æˆ–æ“ä½œå“¡ä½¿ç”¨")
            return
        
        # ç²å–äº¤æ˜“æ‘˜è¦
        summary = config.get_transaction_summary()
        if not summary['withdrawals']:
            bot.reply_to(message, "âŒ æ²’æœ‰å¯æ’¤éŠ·çš„å‡ºæ¬¾è¨˜éŒ„")
            return
        
        # ç²å–æœ€å¾Œä¸€ç­†å‡ºæ¬¾é‡‘é¡ç”¨æ–¼é¡¯ç¤º
        last_amount = abs(summary['withdrawals'][-1]['amount'])
        
        # åŸ·è¡Œæ’¤éŠ·æ“ä½œ
        if config.cancel_last_withdrawal():
            bot.reply_to(message, f"âœ… å·²æ’¤éŠ·æœ€å¾Œä¸€ç­†å‡ºæ¬¾ï¼š{last_amount:,.0f}")
            # æ›´æ–°äº¤æ˜“æ‘˜è¦
            bot.reply_to(message, get_transaction_message())
        else:
            bot.reply_to(message, "âŒ æ’¤éŠ·å‡ºæ¬¾å¤±æ•—")
    except Exception as e:
        bot.reply_to(message, f"âŒ æ’¤éŠ·å‡ºæ¬¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'è¨­å®šç¾¤ç™¼å»£æ’­')
def handle_enable_broadcast(message):
    """è™•ç†å•Ÿç”¨ç¾¤ç™¼å»£æ’­çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "å•Ÿç”¨ç¾¤ç™¼å»£æ’­")
        
        # æª¢æŸ¥æ¬Šé™
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        config.set_broadcast_mode(True)
        bot.reply_to(message, "âœ… å·²å•Ÿç”¨ç¾¤ç™¼å»£æ’­æ¨¡å¼")
    except Exception as e:
        bot.reply_to(message, f"âŒ è¨­å®šç¾¤ç™¼å»£æ’­æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'å–æ¶ˆç¾¤ç™¼å»£æ’­')
def handle_disable_broadcast(message):
    """è™•ç†å–æ¶ˆç¾¤ç™¼å»£æ’­çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "å–æ¶ˆç¾¤ç™¼å»£æ’­")
        
        # æª¢æŸ¥æ¬Šé™
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        
        config.set_broadcast_mode(False)
        bot.reply_to(message, "âœ… å·²å–æ¶ˆç¾¤ç™¼å»£æ’­æ¨¡å¼")
    except Exception as e:
        bot.reply_to(message, f"âŒ å–æ¶ˆç¾¤ç™¼å»£æ’­æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'ğŸ› ï¸ä¿®å¾©æ©Ÿå™¨äºº')
def handle_repair_bot(message):
    """è™•ç†ä¿®å¾©æ©Ÿå™¨äººè«‹æ±‚"""
    repair_message = "ã€Œä½ çš„æ©Ÿå™¨äººå¥½åƒå£æ‰äº†ï¼Ÿã€ å¿«ä¾†ä¿®å¾©å®ƒï¼"
    support_link = "https://t.me/Fanny_Orz"
    
    # å‰µå»ºå¸¶æœ‰é€£çµçš„æ¶ˆæ¯
    response = f"{repair_message}\n\nè¯ç¹«æŠ€è¡“æ”¯æ´ï¼š{support_link}"
    bot.reply_to(message, response)

@bot.message_handler(func=lambda message: message.text == 'åˆªé™¤æ‰€æœ‰èŠå¤©å®¤è¨Šæ¯')
def handle_delete_all_messages(message):
    """è™•ç†åˆªé™¤æ‰€æœ‰èŠå¤©å®¤è¨Šæ¯çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "åˆªé™¤æ‰€æœ‰èŠå¤©å®¤è¨Šæ¯")
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        # ç²å–ç•¶å‰æ¶ˆæ¯ID
        current_message_id = message.message_id
        
        # å¾ç•¶å‰æ¶ˆæ¯é–‹å§‹å¾€å‰åˆªé™¤
        for msg_id in range(current_message_id, 0, -1):
            try:
                bot.delete_message(message.chat.id, msg_id)
            except:
                continue
        
        # ç™¼é€æˆåŠŸæ¶ˆæ¯ï¼ˆé€™æ¢æ¶ˆæ¯ä¹Ÿæœƒè¢«åˆªé™¤ï¼‰
        bot.send_message(message.chat.id, "âœ… å·²æ¸…ç©ºæ‰€æœ‰èŠå¤©å®¤è¨Šæ¯")
    except Exception as e:
        bot.reply_to(message, f"âŒ åˆªé™¤è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == 'åˆªé™¤æ‰€æœ‰éç½®é ‚è¨Šæ¯')
def handle_delete_non_pinned_messages(message):
    """è™•ç†åˆªé™¤æ‰€æœ‰éç½®é ‚è¨Šæ¯çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "åˆªé™¤æ‰€æœ‰éç½®é ‚è¨Šæ¯")
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        # ç²å–ç½®é ‚æ¶ˆæ¯
        try:
            pinned_message = bot.get_chat(message.chat.id).pinned_message
            pinned_message_id = pinned_message.message_id if pinned_message else None
        except:
            pinned_message_id = None

        # ç²å–ç•¶å‰æ¶ˆæ¯ID
        current_message_id = message.message_id
        
        # å¾ç•¶å‰æ¶ˆæ¯é–‹å§‹å¾€å‰åˆªé™¤éç½®é ‚æ¶ˆæ¯
        for msg_id in range(current_message_id, 0, -1):
            try:
                # è·³éç½®é ‚æ¶ˆæ¯
                if pinned_message_id and msg_id == pinned_message_id:
                    continue
                bot.delete_message(message.chat.id, msg_id)
            except:
                continue
        
        # ç™¼é€æˆåŠŸæ¶ˆæ¯ï¼ˆé€™æ¢æ¶ˆæ¯ä¹Ÿæœƒè¢«åˆªé™¤ï¼‰
        bot.send_message(message.chat.id, "âœ… å·²æ¸…ç©ºæ‰€æœ‰éç½®é ‚è¨Šæ¯")
    except Exception as e:
        bot.reply_to(message, f"âŒ åˆªé™¤è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text == '+0')
def handle_show_summary(message):
    """è™•ç†é¡¯ç¤ºäº¤æ˜“æ‘˜è¦çš„è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "æŸ¥çœ‹äº¤æ˜“æ‘˜è¦")
        
        # ç²å–ä¸¦ç™¼é€äº¤æ˜“æ‘˜è¦
        summary = get_transaction_message()
        bot.reply_to(message, summary)
    except Exception as e:
        bot.reply_to(message, f"âŒ ç²å–äº¤æ˜“æ‘˜è¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(func=lambda message: message.text and (message.text.startswith('+') or message.text.startswith('-')))
def handle_transaction(message):
    """è™•ç†å…¥æ¬¾å’Œå‡ºæ¬¾æ“ä½œ"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "å…¥æ¬¾" if message.text.startswith('+') else "å‡ºæ¬¾")
        
        # åˆ¤æ–·æ˜¯å…¥æ¬¾é‚„æ˜¯å‡ºæ¬¾
        is_deposit = message.text.startswith('+')
        action_type = "å…¥æ¬¾" if is_deposit else "å‡ºæ¬¾"
        
        # æå–é‡‘é¡
        amount_str = message.text[1:].replace(',', '')
        try:
            amount = float(amount_str)
        except ValueError:
            bot.reply_to(message, "âŒ é‡‘é¡æ ¼å¼éŒ¯èª¤ï¼")
            return
        
        # æ·»åŠ äº¤æ˜“è¨˜éŒ„
        config.add_transaction(amount, 'deposit' if is_deposit else 'withdrawal')
        
        # ç™¼é€äº¤æ˜“æ‘˜è¦
        bot.reply_to(message, get_transaction_message())
    except Exception as e:
        bot.reply_to(message, f"âŒ è™•ç†{'å…¥' if is_deposit else 'å‡º'}æ¬¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

def is_admin(user_id, chat_id):
    """æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦ç‚ºç¾¤çµ„ç®¡ç†å“¡"""
    try:
        member = bot.get_chat_member(chat_id, user_id)
        return member.status in ['creator', 'administrator']
    except:
        return False

def is_operator(user_id):
    """æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦ç‚ºæ“ä½œå“¡"""
    try:
        return config.is_operator(user_id)
    except:
        return False

def get_rules_message():
    """ç²å–ç¾¤çµ„è¦ç« å…§å®¹"""
    return """åŒ—é‡‘ Northâ„¢Sea á´8á´˜ ç¾¤çµ„è¦ç« 
------------------------------------
1ï¸âƒ£ å¹³æ™‚èˆ‡æ¥­å‹™çš„å°è©±ç´€éŒ„ï¼Œè«‹å‹™å¿…æ”¶å›ç¢ºå¯¦ï¼ä¹¾æ·¨ï¼è«‹å‹¿å°‡ç›¤å£ã€å®¢æˆ¶æŒ‡å®šåœ°é»ç­‰ç­‰ä¹‹ç›¸é—œå°è©±ç•™å­˜ã€‚å‹™å¿…è¦ç¢ºå¯¦æ”¶å›å¾¹åº•ã€‚

2ï¸âƒ£ 1è™Ÿæ¥­å‹™æ›ç·šå…§å®¹ç¢ºå¯¦ï¼Œè£è¢‹å‰å‹™å¿…å†æ¬¡æ¸…é»é‡‘é¡ã€‚ç¢ºèªå¾Œåœ¨ç¶è¢‹ï¼Œè‹¥æ˜¯è‡ªè¡Œå¾Œäº¤å¤–å‹™ä¸»ç®¡ï¼Œå…¨ç¨‹éŒ„å½±ç›´åˆ°çµ¦èˆ‡å¤–å‹™ä¸»ç®¡ã€‚
2è™Ÿ3è™Ÿæ¥­å‹™ç›¸åŒã€‚å…¨ç¨‹éŒ„å½±ç›´åˆ°çµ¦èˆ‡å¤–å‹™ä¸»ç®¡orå¹£å•†ï¼Œæ‰å¯å°‡è¦–é »é—œé–‰ã€‚

3ï¸âƒ£ è‹¥éš”æ—¥æ™¨é–“æœ‰é ç´„å–®ï¼Œå‹™å¿…ç¢ºå¯¦è¨­å®šé¬§é˜ï¼Œä¸¦ä¸”æ‰“é›»è©±å«äººå“¡èµ·åºŠã€‚"""

@bot.message_handler(func=lambda message: message.text == 'ğŸ“ç¾¤çµ„è¦ç« ')
def handle_rules(message):
    """è™•ç†ç¾¤çµ„è¦ç« è«‹æ±‚"""
    try:
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "æŸ¥çœ‹ç¾¤çµ„è¦ç« ")
        
        # ç™¼é€ç¾¤çµ„è¦ç« 
        bot.reply_to(message, get_rules_message())
    except Exception as e:
        bot.reply_to(message, f"âŒ ç²å–ç¾¤çµ„è¦ç« æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(content_types=['new_chat_members'])
def welcome_new_members(message):
    """è™•ç†æ–°æˆå“¡åŠ å…¥ç¾¤çµ„"""
    try:
        for new_member in message.new_chat_members:
            # ç²å–æ–°æˆå“¡ä¿¡æ¯
            surname = new_member.username or f"{new_member.first_name} {new_member.last_name}".strip()
            fullname = f"{new_member.first_name} {new_member.last_name}".strip()
            firstname = new_member.first_name
            groupname = message.chat.title
            
            # ç²å–æ­¡è¿è©æ¨¡æ¿
            welcome_template = config.get_welcome_message()
            
            # æ›¿æ›è®Šæ•¸
            welcome_message = welcome_template.format(
                SURNAME=surname,
                FULLNAME=fullname,
                FIRSTNAME=firstname,
                GROUPNAME=groupname
            )
            
            # ç™¼é€æ­¡è¿æ¶ˆæ¯
            bot.reply_to(message, welcome_message)
            
            # è¨˜éŒ„æ“ä½œ
            log_message(message, f"æ–°æˆå“¡åŠ å…¥ï¼š{surname}")
    except Exception as e:
        logger.error(f"è™•ç†æ–°æˆå“¡åŠ å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

def get_admin_commands_message():
    """ç²å–ç®¡ç†å“¡å‘½ä»¤åˆ—è¡¨"""
    return """ğŸ”° ç¾¤çµ„ç®¡ç†å“¡å‘½ä»¤åˆ—è¡¨ï¼š

ğŸ‘®â€â™‚ï¸ ç®¡ç†å“¡å‘½ä»¤ï¼š
/ban @ç”¨æˆ¶å [æ™‚é–“] [åŸå› ] - ç¦è¨€ç”¨æˆ¶ï¼ˆæ™‚é–“æ ¼å¼ï¼š1h, 1d, 1wï¼‰
/unban @ç”¨æˆ¶å - è§£é™¤ç¦è¨€
/kick @ç”¨æˆ¶å [åŸå› ] - è¸¢å‡ºç”¨æˆ¶
/warn @ç”¨æˆ¶å [åŸå› ] - è­¦å‘Šç”¨æˆ¶
/unwarn @ç”¨æˆ¶å - ç§»é™¤è­¦å‘Š
/warns @ç”¨æˆ¶å - æŸ¥çœ‹è­¦å‘Šæ¬¡æ•¸
/info @ç”¨æˆ¶å - æŸ¥çœ‹ç”¨æˆ¶è³‡è¨Š
/del - å›è¦†è¦åˆªé™¤çš„è¨Šæ¯å³å¯åˆªé™¤

âš ï¸ æ³¨æ„ï¼šè«‹è¬¹æ…ä½¿ç”¨ç®¡ç†å‘½ä»¤"""

@bot.message_handler(commands=['admin'])
def show_admin_commands(message):
    """é¡¯ç¤ºç®¡ç†å“¡å‘½ä»¤åˆ—è¡¨"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return
        bot.reply_to(message, get_admin_commands_message())
    except Exception as e:
        bot.reply_to(message, f"âŒ é¡¯ç¤ºç®¡ç†å“¡å‘½ä»¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(commands=['ban'])
def ban_user(message):
    """ç¦è¨€ç”¨æˆ¶"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        args = message.text.split()
        if len(args) < 2:
            bot.reply_to(message, "âŒ ä½¿ç”¨æ–¹å¼ï¼š/ban @ç”¨æˆ¶å [æ™‚é–“] [åŸå› ]")
            return

        # è§£æå‘½ä»¤åƒæ•¸
        target_username = args[1].replace("@", "")
        duration = None
        reason = "æœªæŒ‡å®šåŸå› "

        if len(args) > 2:
            # è§£ææ™‚é–“ï¼ˆå¦‚æœæœ‰ï¼‰
            time_arg = args[2].lower()
            if time_arg.endswith(('h', 'd', 'w')):
                value = int(time_arg[:-1])
                unit = time_arg[-1]
                if unit == 'h':
                    duration = timedelta(hours=value)
                elif unit == 'd':
                    duration = timedelta(days=value)
                elif unit == 'w':
                    duration = timedelta(weeks=value)

            # è§£æåŸå› 
            if len(args) > 3:
                reason = ' '.join(args[3:])

        # ç²å–ç›®æ¨™ç”¨æˆ¶
        try:
            chat_member = bot.get_chat_member(message.chat.id, f"@{target_username}")
            target_user = chat_member.user
        except:
            bot.reply_to(message, "âŒ æ‰¾ä¸åˆ°æŒ‡å®šç”¨æˆ¶")
            return

        # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        if is_admin(target_user.id, message.chat.id):
            bot.reply_to(message, "âŒ ç„¡æ³•ç¦è¨€ç®¡ç†å“¡")
            return

        # è¨­ç½®ç¦è¨€
        until_date = datetime.now() + duration if duration else None
        bot.restrict_chat_member(
            message.chat.id,
            target_user.id,
            until_date=until_date,
            permissions=telebot.types.ChatPermissions(
                can_send_messages=False,
                can_send_media_messages=False,
                can_send_other_messages=False
            )
        )

        # ç™¼é€ç¦è¨€é€šçŸ¥
        duration_text = f" {duration.days}å¤©" if duration else " æ°¸ä¹…"
        bot.reply_to(message, f"âœ… å·²ç¦è¨€ {target_username}{duration_text}\nåŸå› ï¼š{reason}")
        
        # è¨˜éŒ„æ“ä½œ
        log_message(message, f"ç¦è¨€ç”¨æˆ¶ï¼š{target_username}ï¼ŒåŸå› ï¼š{reason}")
    except Exception as e:
        bot.reply_to(message, f"âŒ ç¦è¨€ç”¨æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(commands=['unban'])
def unban_user(message):
    """è§£é™¤ç”¨æˆ¶ç¦è¨€"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        args = message.text.split()
        if len(args) < 2:
            bot.reply_to(message, "âŒ ä½¿ç”¨æ–¹å¼ï¼š/unban @ç”¨æˆ¶å")
            return

        target_username = args[1].replace("@", "")

        try:
            chat_member = bot.get_chat_member(message.chat.id, f"@{target_username}")
            target_user = chat_member.user
        except:
            bot.reply_to(message, "âŒ æ‰¾ä¸åˆ°æŒ‡å®šç”¨æˆ¶")
            return

        # è§£é™¤ç¦è¨€
        bot.restrict_chat_member(
            message.chat.id,
            target_user.id,
            permissions=telebot.types.ChatPermissions(
                can_send_messages=True,
                can_send_media_messages=True,
                can_send_other_messages=True
            )
        )

        bot.reply_to(message, f"âœ… å·²è§£é™¤ {target_username} çš„ç¦è¨€")
        
        # è¨˜éŒ„æ“ä½œ
        log_message(message, f"è§£é™¤ç¦è¨€ï¼š{target_username}")
    except Exception as e:
        bot.reply_to(message, f"âŒ è§£é™¤ç¦è¨€æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(commands=['kick'])
def kick_user(message):
    """è¸¢å‡ºç”¨æˆ¶"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        args = message.text.split()
        if len(args) < 2:
            bot.reply_to(message, "âŒ ä½¿ç”¨æ–¹å¼ï¼š/kick @ç”¨æˆ¶å [åŸå› ]")
            return

        target_username = args[1].replace("@", "")
        reason = "æœªæŒ‡å®šåŸå› " if len(args) < 3 else ' '.join(args[2:])

        try:
            chat_member = bot.get_chat_member(message.chat.id, f"@{target_username}")
            target_user = chat_member.user
        except:
            bot.reply_to(message, "âŒ æ‰¾ä¸åˆ°æŒ‡å®šç”¨æˆ¶")
            return

        # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        if is_admin(target_user.id, message.chat.id):
            bot.reply_to(message, "âŒ ç„¡æ³•è¸¢å‡ºç®¡ç†å“¡")
            return

        # è¸¢å‡ºç”¨æˆ¶
        bot.kick_chat_member(message.chat.id, target_user.id)
        bot.unban_chat_member(message.chat.id, target_user.id)  # è§£é™¤å°é–ï¼Œå…è¨±ç”¨æˆ¶å†æ¬¡åŠ å…¥

        bot.reply_to(message, f"âœ… å·²è¸¢å‡º {target_username}\nåŸå› ï¼š{reason}")
        
        # è¨˜éŒ„æ“ä½œ
        log_message(message, f"è¸¢å‡ºç”¨æˆ¶ï¼š{target_username}ï¼ŒåŸå› ï¼š{reason}")
    except Exception as e:
        bot.reply_to(message, f"âŒ è¸¢å‡ºç”¨æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(commands=['warn'])
def warn_user(message):
    """è­¦å‘Šç”¨æˆ¶"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        args = message.text.split()
        if len(args) < 2:
            bot.reply_to(message, "âŒ ä½¿ç”¨æ–¹å¼ï¼š/warn @ç”¨æˆ¶å [åŸå› ]")
            return

        target_username = args[1].replace("@", "")
        reason = "æœªæŒ‡å®šåŸå› " if len(args) < 3 else ' '.join(args[2:])

        try:
            chat_member = bot.get_chat_member(message.chat.id, f"@{target_username}")
            target_user = chat_member.user
        except:
            bot.reply_to(message, "âŒ æ‰¾ä¸åˆ°æŒ‡å®šç”¨æˆ¶")
            return

        # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        if is_admin(target_user.id, message.chat.id):
            bot.reply_to(message, "âŒ ç„¡æ³•è­¦å‘Šç®¡ç†å“¡")
            return

        # æ·»åŠ è­¦å‘Š
        warns = config.add_warning(target_user.id)
        
        warning_message = f"âš ï¸ {target_username} å·²è¢«è­¦å‘Š\n"
        warning_message += f"åŸå› ï¼š{reason}\n"
        warning_message += f"è­¦å‘Šæ¬¡æ•¸ï¼š{warns}/3\n"
        
        if warns >= 3:
            # è‡ªå‹•ç¦è¨€ 24 å°æ™‚
            until_date = datetime.now() + timedelta(days=1)
            bot.restrict_chat_member(
                message.chat.id,
                target_user.id,
                until_date=until_date,
                permissions=telebot.types.ChatPermissions(
                    can_send_messages=False,
                    can_send_media_messages=False,
                    can_send_other_messages=False
                )
            )
            warning_message += "\nâ—ï¸ å·²é”åˆ°è­¦å‘Šä¸Šé™ï¼Œè‡ªå‹•ç¦è¨€ 24 å°æ™‚"
            config.clear_warnings(target_user.id)  # æ¸…ç©ºè­¦å‘Šæ¬¡æ•¸

        bot.reply_to(message, warning_message)
        
        # è¨˜éŒ„æ“ä½œ
        log_message(message, f"è­¦å‘Šç”¨æˆ¶ï¼š{target_username}ï¼ŒåŸå› ï¼š{reason}")
    except Exception as e:
        bot.reply_to(message, f"âŒ è­¦å‘Šç”¨æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(commands=['unwarn'])
def unwarn_user(message):
    """ç§»é™¤ç”¨æˆ¶è­¦å‘Š"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        args = message.text.split()
        if len(args) < 2:
            bot.reply_to(message, "âŒ ä½¿ç”¨æ–¹å¼ï¼š/unwarn @ç”¨æˆ¶å")
            return

        target_username = args[1].replace("@", "")

        try:
            chat_member = bot.get_chat_member(message.chat.id, f"@{target_username}")
            target_user = chat_member.user
        except:
            bot.reply_to(message, "âŒ æ‰¾ä¸åˆ°æŒ‡å®šç”¨æˆ¶")
            return

        # ç§»é™¤ä¸€æ¬¡è­¦å‘Š
        warns = config.remove_warning(target_user.id)
        
        bot.reply_to(message, f"âœ… å·²ç§»é™¤ {target_username} çš„ä¸€æ¬¡è­¦å‘Š\nç•¶å‰è­¦å‘Šæ¬¡æ•¸ï¼š{warns}/3")
        
        # è¨˜éŒ„æ“ä½œ
        log_message(message, f"ç§»é™¤è­¦å‘Šï¼š{target_username}")
    except Exception as e:
        bot.reply_to(message, f"âŒ ç§»é™¤è­¦å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(commands=['warns'])
def check_warns(message):
    """æŸ¥çœ‹ç”¨æˆ¶è­¦å‘Šæ¬¡æ•¸"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        args = message.text.split()
        if len(args) < 2:
            bot.reply_to(message, "âŒ ä½¿ç”¨æ–¹å¼ï¼š/warns @ç”¨æˆ¶å")
            return

        target_username = args[1].replace("@", "")

        try:
            chat_member = bot.get_chat_member(message.chat.id, f"@{target_username}")
            target_user = chat_member.user
        except:
            bot.reply_to(message, "âŒ æ‰¾ä¸åˆ°æŒ‡å®šç”¨æˆ¶")
            return

        # ç²å–è­¦å‘Šæ¬¡æ•¸
        warns = config.get_warnings(target_user.id)
        
        bot.reply_to(message, f"ğŸ‘¤ ç”¨æˆ¶ï¼š{target_username}\nâš ï¸ è­¦å‘Šæ¬¡æ•¸ï¼š{warns}/3")
    except Exception as e:
        bot.reply_to(message, f"âŒ æŸ¥çœ‹è­¦å‘Šæ¬¡æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(commands=['info'])
def user_info(message):
    """æŸ¥çœ‹ç”¨æˆ¶è³‡è¨Š"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        args = message.text.split()
        if len(args) < 2:
            bot.reply_to(message, "âŒ ä½¿ç”¨æ–¹å¼ï¼š/info @ç”¨æˆ¶å")
            return

        target_username = args[1].replace("@", "")

        try:
            chat_member = bot.get_chat_member(message.chat.id, f"@{target_username}")
            user = chat_member.user
        except:
            bot.reply_to(message, "âŒ æ‰¾ä¸åˆ°æŒ‡å®šç”¨æˆ¶")
            return

        # ç²å–ç”¨æˆ¶è³‡è¨Š
        info_message = f"""ğŸ‘¤ ç”¨æˆ¶è³‡è¨Šï¼š
IDï¼š{user.id}
ç”¨æˆ¶åï¼š@{user.username}
åå­—ï¼š{user.first_name}
å§“æ°ï¼š{user.last_name or 'ç„¡'}
æ˜¯å¦ç‚ºæ©Ÿå™¨äººï¼š{'æ˜¯' if user.is_bot else 'å¦'}
ç‹€æ…‹ï¼š{chat_member.status}
è­¦å‘Šæ¬¡æ•¸ï¼š{config.get_warnings(user.id)}/3"""

        bot.reply_to(message, info_message)
    except Exception as e:
        bot.reply_to(message, f"âŒ ç²å–ç”¨æˆ¶è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(commands=['del'])
def delete_message(message):
    """åˆªé™¤è¨Šæ¯"""
    try:
        if not is_admin(message.from_user.id, message.chat.id):
            bot.reply_to(message, "âŒ æ­¤å‘½ä»¤åƒ…é™ç®¡ç†å“¡ä½¿ç”¨")
            return

        # æª¢æŸ¥æ˜¯å¦ç‚ºå›è¦†è¨Šæ¯
        if not message.reply_to_message:
            bot.reply_to(message, "âŒ è«‹å›è¦†è¦åˆªé™¤çš„è¨Šæ¯")
            return

        # åˆªé™¤ç›®æ¨™è¨Šæ¯
        bot.delete_message(message.chat.id, message.reply_to_message.message_id)
        # åˆªé™¤å‘½ä»¤è¨Šæ¯
        bot.delete_message(message.chat.id, message.message_id)
        
        # è¨˜éŒ„æ“ä½œ
        log_message(message, "åˆªé™¤è¨Šæ¯")
    except Exception as e:
        bot.reply_to(message, f"âŒ åˆªé™¤è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

@bot.message_handler(content_types=['left_chat_member'])
def handle_member_left(message):
    """è™•ç†æˆå“¡é›¢é–‹ç¾¤çµ„"""
    try:
        # æª¢æŸ¥æ˜¯å¦å•Ÿç”¨å‘Šåˆ¥è¨Šæ¯
        if not config.get_farewell_enabled():
            return
        
        left_member = message.left_chat_member
        # ç²å–é›¢é–‹æˆå“¡ä¿¡æ¯
        surname = left_member.username or f"{left_member.first_name} {left_member.last_name}".strip()
        fullname = f"{left_member.first_name} {left_member.last_name}".strip()
        firstname = left_member.first_name
        groupname = message.chat.title
        
        # ç²å–å‘Šåˆ¥è©æ¨¡æ¿
        farewell_template = config.get_farewell_message()
        
        # æ›¿æ›è®Šæ•¸
        farewell_message = farewell_template.format(
            SURNAME=surname,
            FULLNAME=fullname,
            FIRSTNAME=firstname,
            GROUPNAME=groupname
        )
        
        # ç™¼é€å‘Šåˆ¥æ¶ˆæ¯
        bot.reply_to(message, farewell_message)
        
        # è¨˜éŒ„æ“ä½œ
        log_message(message, f"æˆå“¡é›¢é–‹ï¼š{surname}")
    except Exception as e:
        logger.error(f"è™•ç†æˆå“¡é›¢é–‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

# é‹è¡Œæ©Ÿå™¨äºº
if __name__ == '__main__':
    print("æ©Ÿå™¨äººå·²å•Ÿå‹•...")
    logger.info("æ©Ÿå™¨äººå·²å•Ÿå‹•...")
    bot.infinity_polling() 